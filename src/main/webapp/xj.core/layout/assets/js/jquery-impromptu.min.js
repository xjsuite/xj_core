
(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery"],b)}else{b(a.jQuery)}}(this,function(b){var a=function(e,c){var d=this;d.id=a.count++;a.lifo.push(d);if(e){d.open(e,c)}return d};a.defaults={prefix:"xj",classes:{box:"",fade:"",prompt:"",form:"",close:"btn btn-danger",title:"",message:"",buttons:"",button:"",defaultButton:""},title:"",closeText:'<i class="fa fa-close"> </i>',buttons:{Ok:true},buttonTimeout:1000,loaded:function(c){},submit:function(h,d,c,g){},close:function(h,d,c,g){},statechanging:function(c,f,d){},statechanged:function(c,d){},opacity:0.6,zIndex:999,overlayspeed:"slow",promptspeed:"fast",show:"fadeIn",hide:"fadeOut",focus:0,defaultButton:0,useiframe:false,top:"15%",position:{container:null,x:null,y:null,arrow:null,width:null},persistent:true,timeout:0,states:{},initialState:0,state:{name:null,title:"",html:"",buttons:{Ok:true},focus:0,defaultButton:0,position:{container:null,x:null,y:null,arrow:null,width:null},submit:function(h,d,c,g){return true}}};a.setDefaults=function(c){a.defaults=b.extend({},a.defaults,c)};a.setStateDefaults=function(c){a.defaults.state=b.extend({},a.defaults.state,c)};a.count=0;a.lifo=[];a.getLast=function(){var c=a.lifo.length;return(c>0)?a.lifo[c-1]:false};a.removeFromStack=function(d){for(var c=a.lifo.length-1;c>=0;c--){if(a.lifo[c].id===d){return a.lifo.splice(c,1)[0]}}};a.prototype={id:null,open:function(m,n){var l=this;l.options=b.extend({},a.defaults,n);if(l.timeout){clearTimeout(l.timeout)}l.timeout=false;var c=l.options,g=b(document.body),e=b(window);var d='<div class="'+c.prefix+"box "+c.classes.box+'">';if(c.useiframe&&(b("object, applet").length>0)){d+='<iframe src="javascript:false;" class="'+c.prefix+"fade "+c.classes.fade+'"></iframe>'}else{d+='<div class="'+c.prefix+"fade "+c.classes.fade+'"></div>'}d+='<div class="'+c.prefix+" "+c.classes.prompt+'"><div class="xjheader"><h4 id="xj-title" class="xjheadertitle">Confirmation</h4></div><form action="#" class="'+c.prefix+"form "+c.classes.form+'"><div class="'+c.prefix+'states"></div></form></div></div>';l.jqib=b(d).appendTo(g);l.jqi=l.jqib.children("."+c.prefix);l.jqif=l.jqib.children("."+c.prefix+"fade");if(m.constructor===String){m={state0:{title:c.title,html:m,buttons:c.buttons,position:c.position,focus:c.focus,defaultButton:c.defaultButton,submit:c.submit}}}l.options.states={};var f,j;for(f in m){j=b.extend({},a.defaults.state,{name:f},m[f]);l.addState(j.name,j);if(l.currentStateName===""){l.currentStateName=j.name}}l.jqi.on("click","."+c.prefix+"buttons button",function(u){var s=b(this),k=s.parents("."+c.prefix+"state"),t=k.data("jqi-name"),w=l.options.states[t],q=k.children("."+c.prefix+"message"),v=w.buttons[s.text()]||w.buttons[s.html()],o={};if(l.options.buttonTimeout>0){l.disableStateButtons(t);setTimeout(function(){l.enableStateButtons(t)},l.options.buttonTimeout)}if(v===undefined){for(var r in w.buttons){if(w.buttons[r].title===s.text()||w.buttons[r].title===s.html()){v=w.buttons[r].value}}}b.each(l.jqi.children("form").serializeArray(),function(x,y){if(o[y.name]===undefined){o[y.name]=y.value}else{if(typeof o[y.name]===Array||typeof o[y.name]==="object"){o[y.name].push(y.value)}else{o[y.name]=[o[y.name],y.value]}}});var p=new b.Event("impromptu:submit");p.stateName=w.name;p.state=k;k.trigger(p,[v,q,o]);if(!p.isDefaultPrevented()){l.close(true,v,q,o)}});var i=function(){if(c.persistent){var o=(c.top.toString().indexOf("%")>=0?(e.height()*(parseInt(c.top,10)/100)):parseInt(c.top,10)),k=parseInt(l.jqi.css("top").replace("px",""),10)-o;b("html,body").animate({scrollTop:k},"fast",function(){var q=0;l.jqib.addClass(c.prefix+"warning");var p=setInterval(function(){l.jqib.toggleClass(c.prefix+"warning");if(q++>1){clearInterval(p);l.jqib.removeClass(c.prefix+"warning")}},100)})}else{l.close(true)}};var h=function(s){var q=(window.event)?event.keyCode:s.keyCode;if(q===27){i()}if(q===13){var r=l.getCurrentState().find("."+c.prefix+"defaultbutton");var k=b(s.target);if(k.is("textarea,."+c.prefix+"button")===false&&r.length>0){s.preventDefault();r.click()}}if(q===9){var t=b("input,select,textarea,button",l.getCurrentState());var p=!s.shiftKey&&s.target===t[t.length-1];var o=s.shiftKey&&s.target===t[0];if(p||o){setTimeout(function(){if(!t){return}var u=t[o===true?t.length-1:0];if(u){u.focus()}},10);return false}}};l.position();l.style();l._windowResize=function(k){l.position(k)};e.resize({animate:false},l._windowResize);l.jqif.click(i);l.jqi.find("."+c.prefix+"close").click(function(){l.close()});l.jqi.find("."+c.prefix+"form").submit(function(){return false});l.jqib.on("keydown",h).on("impromptu:loaded",c.loaded).on("impromptu:close",c.close).on("impromptu:statechanging",c.statechanging).on("impromptu:statechanged",c.statechanged);l.jqif[c.show](c.overlayspeed);l.jqi[c.show](c.promptspeed,function(){l.goToState(isNaN(c.initialState)?c.initialState:l.jqi.find("."+c.prefix+"states ."+c.prefix+"state").eq(c.initialState).data("jqi-name"));l.jqib.trigger("impromptu:loaded")});if(c.timeout>0){l.timeout=setTimeout(function(){l.close(true)},c.timeout)}return l},close:function(f,e,g,c){var d=this;a.removeFromStack(d.id);if(d.timeout){clearTimeout(d.timeout);d.timeout=false}if(d.jqib){d.jqib[d.options.hide]("fast",function(){d.jqib.trigger("impromptu:close",[e,g,c]);d.jqib.remove();b(window).off("resize",d._windowResize);if(typeof f==="function"){f()}})}d.currentStateName="";return d},addState:function(c,w,f){var m=this,g="",u=null,e="",z="",n=m.options,h=b.isFunction(w.position)?w.position():w.position,o=m.jqi.find("."+n.prefix+"states"),s=[],y,d,q,j,p,r=0;w=b.extend({},a.defaults.state,{name:c},w);if(b.isPlainObject(h)&&h.arrow!==null){e='<div class="'+n.prefix+"arrow "+n.prefix+"arrow"+h.arrow+'"></div>'}if(w.title&&w.title!==""){z='<div class="lead '+n.prefix+"title "+n.classes.title+'">'+w.title+"</div>"}y=w.html;if(typeof w.html==="function"){y="Error: html function must return text"}g+='<div class="'+n.prefix+'state" data-jqi-name="'+c+'">'+e+z+'<div class="'+n.prefix+"message "+n.classes.message+'">'+y+'</div><div class="'+n.prefix+"buttons"+(b.isEmptyObject(w.buttons)?"hide ":" ")+n.classes.buttons+'">';if(b.isArray(w.buttons)){s=w.buttons}else{if(b.isPlainObject(w.buttons)){for(q in w.buttons){if(w.buttons.hasOwnProperty(q)){s.push({title:q,value:w.buttons[q]})}}}}for(r=0,p=s.length;r<p;r++){j=s[r],d=w.focus===r||(isNaN(w.focus)&&w.defaultButton===r)?(n.prefix+"defaultbutton "+n.classes.defaultButton):"";var x="btn btn-success";if(d===""){x="btn btn-warning"}g+='<button class="'+x+" "+n.classes.button+" "+n.prefix+"button "+d;if(typeof j.classes!=="undefined"){g+=" "+(b.isArray(j.classes)?j.classes.join(" "):j.classes)+" "}g+='" name="'+n.prefix+"_"+c+"_button"+j.title.replace(/[^a-z0-9]+/gi,"")+'" value="'+j.value+'">'+j.title+"</button>"}g+="</div></div>";u=b(g).css({display:"none"});u.on("impromptu:submit",w.submit);if(f!==undefined){m.getState(f).after(u)}else{o.append(u)}m.options.states[c]=w;return u},removeState:function(e,g){var d=this,c=d.getState(e),f=function(){c.remove()};if(c.length===0){return false}if(c.css("display")!=="none"){if(g!==undefined&&d.getState(g).length>0){d.goToState(g,false,f)}else{if(c.next().length>0){d.nextState(f)}else{if(c.prev().length>0){d.prevState(f)}else{d.close()}}}}else{c.slideUp("slow",f)}return true},getApi:function(){return this},getBox:function(){return this.jqib},getPrompt:function(){return this.jqi},getState:function(c){return this.jqi.find('[data-jqi-name="'+c+'"]')},getCurrentState:function(){return this.getState(this.getCurrentStateName())},getCurrentStateName:function(){return this.currentStateName},disableStateButtons:function(f,e,c){var d=this;if(b.isArray(f)){e=f;f=null}d.getState(f||d.getCurrentStateName()).find("."+d.options.prefix+"button").each(function(h,g){if(e===undefined||b.inArray(g.value,e)!==-1){g.disabled=!c}})},enableStateButtons:function(d,c){this.disableStateButtons(d,c,true)},position:function(l){var r=this,i=b.fx.off,d=r.getCurrentState(),f=r.options.states[d.data("jqi-name")],n=f?b.isFunction(f.position)?f.position():f.position:undefined,h=b(window),q=document.body.scrollHeight,c=b(window).height(),p=b(document).height(),o=(q>c)?q:c,g=parseInt(h.scrollTop(),10),m=g+(r.options.top.toString().indexOf("%")>=0?(c*(parseInt(r.options.top,10)/100)):parseInt(r.options.top,10));if(l!==undefined&&l.data.animate===false){b.fx.off=true}r.jqib.css({position:"absolute",height:o,width:"100%",top:0,left:0,right:0,bottom:0});r.jqif.css({position:"fixed",height:o,width:"100%",top:0,left:0,right:0,bottom:0});if(n&&n.container){var j=b(n.container).offset(),k=false;if(b.isPlainObject(j)&&j.top!==undefined){m=(j.top+n.y)-(r.options.top.toString().indexOf("%")>=0?(c*(parseInt(r.options.top,10)/100)):parseInt(r.options.top,10));r.jqi.css({position:"absolute"});r.jqi.animate({top:j.top+n.y,left:j.left+n.x,marginLeft:0,width:(n.width!==undefined)?n.width:null},function(){if(!k&&(j.top+n.y+r.jqi.outerHeight(true))>(g+c)){b("html,body").animate({scrollTop:m},"slow","swing",function(){});k=true}});if(m<g||m>g+c){b("html,body").animate({scrollTop:m},"slow","swing",function(){});k=true}}}else{if(n&&n.width){r.jqi.css({position:"absolute",left:"50%"});r.jqi.animate({top:n.y||m,left:n.x||"50%",marginLeft:((n.width/2)*-1),width:n.width})}else{r.jqi.css({position:"absolute",top:m,left:"50%",marginLeft:((r.jqi.outerWidth(false)/2)*-1)})}}if(l!==undefined&&l.data.animate===false){b.fx.off=i}},style:function(){var c=this;c.jqif.css({zIndex:c.options.zIndex,display:"none",opacity:c.options.opacity});c.jqi.css({zIndex:c.options.zIndex+1,display:"none"});c.jqib.css({zIndex:c.options.zIndex})},goToState:function(e,j,k){var l=this,i=l.jqi,g=l.options,d=l.getState(e),m=g.states[d.data("jqi-name")],f=new b.Event("impromptu:statechanging"),c=l.options;if(m!==undefined){if(typeof m.html==="function"){var h=m.html;d.find("."+c.prefix+"message ").html(h())}if(typeof j==="function"){k=j;j=false}l.jqib.trigger(f,[l.getCurrentStateName(),e]);if(!f.isDefaultPrevented()&&d.length>0){l.jqi.find("."+c.prefix+"parentstate").removeClass(c.prefix+"parentstate");if(j){l.jqi.find("."+c.prefix+"substate").not(d).slideUp(g.promptspeed).removeClass("."+c.prefix+"substate").find("."+c.prefix+"arrow").hide();l.jqi.find("."+c.prefix+"state:visible").addClass(c.prefix+"parentstate");d.addClass(c.prefix+"substate")}else{l.jqi.find("."+c.prefix+"state").not(d).slideUp(g.promptspeed).find("."+c.prefix+"arrow").hide()}l.currentStateName=m.name;d.slideDown(g.promptspeed,function(){var n=b(this);l.enableStateButtons();if(typeof(m.focus)==="string"){n.find(m.focus).eq(0).focus()}else{n.find("."+c.prefix+"defaultbutton").focus()}n.find("."+c.prefix+"arrow").show(g.promptspeed);if(typeof k==="function"){l.jqib.on("impromptu:statechanged",k)}l.jqib.trigger("impromptu:statechanged",[e]);if(typeof k==="function"){l.jqib.off("impromptu:statechanged",k)}});if(!j){l.position()}}}return d},nextState:function(e){var d=this,c=d.getCurrentState().next();if(c.length>0){d.goToState(c.data("jqi-name"),e)}return c},prevState:function(e){var d=this,c=d.getCurrentState().prev();if(c.length>0){d.goToState(c.data("jqi-name"),e)}return c}};b.prompt=function(e,c){var d=new a(e,c);return d.jqi};b.each(a,function(d,c){b.prompt[d]=c});b.each(a.prototype,function(d,c){b.prompt[d]=function(){var e=a.getLast();if(e&&typeof e[d]==="function"){return e[d].apply(e,arguments)}}});b.fn.prompt=function(c){if(c===undefined){c={}}if(c.withDataAndEvents===undefined){c.withDataAndEvents=false}b.prompt(b(this).clone(c.withDataAndEvents).html(),c)};window.Impromptu=a}));